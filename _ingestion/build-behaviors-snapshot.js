import fs from 'fs/promises';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const SRC_DIR = path.join(__dirname, '../src/scripts');
const OUTPUT_FILE = path.join(__dirname, 'behaviors-snapshot.js');

async function buildSnapshot() {
    try {
        // 1. Get all files
        const files = await fs.readdir(SRC_DIR);

        // 2. Filter and sort files
        // We want global.ts, header.ts, then page-*.ts
        // We exclude main.ts and any non-ts files
        const targetFiles = files.filter(f =>
            f.endsWith('.ts') &&
            f !== 'main.ts' &&
            !f.endsWith('.d.ts')
        );

        const orderedFiles = [];

        // Explicit order for core files
        if (targetFiles.includes('global.ts')) orderedFiles.push('global.ts');
        if (targetFiles.includes('header.ts')) orderedFiles.push('header.ts');

        // Alphabetical order for the rest (mostly pages)
        const otherFiles = targetFiles
            .filter(f => f !== 'global.ts' && f !== 'header.ts')
            .sort();

        orderedFiles.push(...otherFiles);

        let snapshotContent = `// @ts-nocheck
// AUTO-GENERATED FILE â€” DO NOT EDIT
// This file is a snapshot of all behavior/animation scripts from src/scripts/*.ts
// Generated by _ingestion/build-behaviors-snapshot.js
// Date: ${new Date().toISOString()}

`;

        // 3. Process each file
        for (const file of orderedFiles) {
            const filePath = path.join(SRC_DIR, file);
            const content = await fs.readFile(filePath, 'utf-8');

            // Remove imports (lines starting with import ...)
            // Remove export keywords (export class, export function, export const...)
            const processedContent = content
                .split('\n')
                .filter(line => !line.trim().startsWith('import '))
                .map(line => line.replace(/^export\s+/, '')) // Remove 'export ' at start of line
                .join('\n');

            snapshotContent += `
// ==========================================
// ===== From src/scripts/${file} =====
// ==========================================

${processedContent}
`;
        }

        // 4. Write output
        await fs.writeFile(OUTPUT_FILE, snapshotContent, 'utf-8');
        console.log(`Snapshot generated at: ${OUTPUT_FILE}`);
        console.log(`Files included: ${orderedFiles.join(', ')}`);

    } catch (error) {
        console.error('Error building snapshot:', error);
        process.exit(1);
    }
}

buildSnapshot();
